<meta charset="utf-8">
**目录**

----
[TOC]


##项目简介
> 项目整体介绍

####简介
	面向企业的电商项目，sass模式软件，主要有面向经销商、面向代理商及面向普通客户三种不同的模式
	系统有PC端及移动端
	PC端主要实现各经销商、代理商及企业间的多级/跨级订货需求
	移动端实现企业面向直接用户的电商模式，实现全民开店
	目的即满足企业的多渠道/全渠道营销策略，帮助企业更快速有效的扩展业务，获取利润

* 使用到的技术
	
	JVM使用java8,Tomcat容器使用7+版本
	项目中主要框架有：Spring容器、SpringMVC框架、Freemarker模板引擎
	数据持久层使用SpringJdbc
	数据库暂时使用SqlServer(方便与K3cloud对接)
	日志操作使用Log4j

####系统设计要点
	因为系统是面向客户的，不同的客户可能有不同的定制化需求，所以系统强调灵活性
	sass模式，在项目中的体现为：不同客户实行数据隔离

* 动态数据源

	主要针对大中型客户，数据量大的情况下，使用多账套分离用户数据
	在用户访问系统时，根据用户所在公司的不同，系统动态分配账套
	对用户账套信息实现内部可控管理，在项目中主要早`manager`工程下实现

* 页面`组件化`
	
    为了实现用户可定制化页面的需求，对页面采用`组件化`的策略
    项目中体现页面信息在数据库中配置，且对模板进行扩展，每个页面都由不同的`组件`组成
    在模板渲染过程中，找到不同的页面`组件`，组合成目标页面
    开发人员面向的是**组件开发**，针对不同的组件，`填充`相应的数据

* 可定制化页面
	
	将实现用户可视化定制/组建页面的功能，暂时只有个雏形，待后期完善

* 后端代码实现前端js
	
	使用开发人员更为熟悉的java代码来实现前端js效果，完善中

* 想起来再补...

##项目代码结构
![项目列表结构](img/project_list.png)
> 项目结构列表,当前项目开发主要面向**`Web.*`**工程下面的代码

####Base
	包含Base.Core、Base.Dao、Base.Service、Base.WebApp4个工程

* **Base.Core**	
	
    存放支付相关请求、绑定对象、工具类，**`普通功能开发不用关注此工程`**

* **Base.Dao、Base.Service、Base.WebApp**

	存放`用户登录`、`页面组件/模块配置`、`登录拦截`、`请求配置`、`页面自定义标签`、`K3Cloud接口调用`等

	![](img/base_web_xml.png)
	
	> `Base.WebApp`下的配置文件
	`interceptor-application.xml`为登录拦截器配置
	`widget-application.xml`为Freemarker自定义标签配置

####Bos

	包含Bos、Bos.Server、Bos.WebApp3个工程

* **Bos**
	
	存放所有`基础数据库操作类`、`基础动态表单操作类`、`自定义异常`、`基础对象`、`基础工具类`,项目的几乎所有基础代码都存放在此工程下，另外工程下的`commonbaselib.userlibraries`的配置文件指定所有需要引用的第三方jar包

* **Bos.Server**

	暂未启用

* **Bos.WebApp**

	用于页面的基础动态表单`js`操作，将前台需要的`js`代码全部迁移到后台，使用`java`程序生成相关的`javascript`操作

####Entity
	Kingdee.K3.O2O.Entity单个工程，用于存放基础常量类、项目中抽象出来的一些对象

####Manage
	存放站点数据源管理相关代码，普通功能开发无须关注

####Web
	包含当前开发版本的大部分业务/功能代码，是开发人员直接面向的工程
	按包区分不同模块，编码时注意所在模块，保持代码结构清晰
	
* **Web.Dao**
	- 项目数据持久层
	- 后期会根据`WebContext`针对不同客户的不同数据源进行优化
	- 原来使用`MyBatis`作为持久层框架，现在直接使用`Spring jdbc`
	- `Dao`层添加单元测试，在`test/src`下的`WebDaoTest.java`中有详细说明

* **Web.Service**
	- 业务操作层，在`Service`中实现业务逻辑
	- 当前未添加事务，后期在`Service`层添加事务控制

* **Web.WebApp**
	- 页面模板存放在 etc/ftl/web/widget目录下
	- default目录存放页面模板
	- widget目录存放模板组件
	- 模板与组件使用自定义标签`<widget name="*"/>`关联
	- 当前页面使用的第三方`js`库在`/Kingdee.K3.O2O.Web.WebApp/etc/ftl/web/widget/default/static/`下，而非`/Kingdee.K3.O2O.Web.WebApp/etc/static`目录

####WebServer
	包含大部分配置文件：spring bean相关、jdbc数据源相关、log4j相关
	以及freemark模板相关及其它配置文件，在/etc/WEB-INF/classes目录下
	包含所有第三方jar包，在/etc/WEB-INF/lib的各个目录下
	包含web.xml配置文件，在/etc/WEB-INF目录下
	包含Ant的属性配置及整个项目的总构建文件build.xml

> 前面有提到过，再重复一次。项目构建完成后，真实运行目录在`Kingdee.K3.O2O.Web.WebServer\bin\webapp`下


##项目构建/发布及启动
> 项目的构建过程及启动方法

####项目构建/发布
* 添加build.xml配置文件，流程如下图所示：

	![1.打开添加窗口](img/项目构建_1.png)

	![2.添加指定build.xml文件](img/项目构建_2.png)

	![3.选择指定target](img/项目构建_3.png)

* 默认如上图所示，仅需添加`Deploy All`,表示**构建全部**
	
	运行`Ant`工具，会将所有工程打成`jar`包复制到`Kingdee.K3.O2O.Web.WebServer\bin`目录下

####项目启动
* 配置`Tomcat`
	
	添加**Apache Tomcat 7+**版本

* 修改`Server.xml`中修改配置，如下示例：
	```xml
	<Host appBase="webapps" autoDeploy="true" name="localhost" unpackWARs="true">
	      	<Alias>o2o.kingdee.com</Alias>
			<Alias>*.o2o.kingdee.com</Alias>	
	        <Valve className="org.apache.catalina.valves.AccessLogValve" 
	        directory="logs" pattern="%h %l %u %t &quot;%r&quot; %s %b" 
	        prefix="localhost_access_log" suffix=".txt"/>
	        
	       <Context debug="0" 
	       docBase="\Kingdee.K3.O2O.Web.WebServer\bin\webapp"
	        path="/" reloadable="true"/> <!-- privileged="true"  --> 
	</Host>	
	```
	`<Alias>`用于配置请求别名，可实现项目中店铺间不同`URL`请求的<abbr title="动态域名">动态域名</abbr>效果（另外还需要修改`Windows/System32/drivers/etc/`下的`hosts`文件，增加`127.0.0.1  o2o.kingdee.com`）

* 启动`Tomcat`
	
	启动`Tomcat`,将根据`Server.xml`配置文件指定的目录启动项目

* 访问项目
	
	以配置文件中配置的`<Alias>`中配置的别名作为`域名`请求当前项目

##项目主要流程
	梳理项目的总体流程及正常页面开发步骤

####实现细节

* 请求拦截	

	> web.xml配置SpringMVC拦截所有"*.jhtml"请求

* 页面请求
	
	> 页面请求URL为：`http://domain/view.jhtml?page=*`(domain[^domain])
	主页为：`http://domain/view.jhtml?page=home`或直接请求`http://domain`
	因为系统配置的<kbd>welcome-list</kbd>指向`view.jhtml`，而在<kbd>view.jhtml</kbd>指定的控制器中会将请求转向`page=home`

* 请求处理流程

	- 主页流程
		welcome-list[^welcome-list]、@RequestMapping("/view")[^view]
	
```flow
start=>start: 用户请求
getUrl=>operation: 获取URL
urlCond=>condition: URL以/view.jhtml结束
urlWelc=>operation: 找到配置的welcome-list
urlOp=>operation: @RequestMapping("/view")
end=>end: 结束

start->getUrl->urlCond
urlCond(yes)->end
urlCond(no)->urlWelc->urlOp->end
```


####主页
	项目主页完整 URL地址:http://domain/view.jhtml?page=home

##编码规范
> ***要求***：命名合理 注释详细 结构清晰 有效率

####命名

* 禁止使用毫无含义的ABCD、数字、下划线当作包/类/字段名,如：`UserA/User2`；使用准确的英文翻译当作类名/字段名
* 命名统一遵循`驼峰`标识，类/接口名首字母大写，如：类名`UserService`；字段首字母小写，如：`userName`
* 避免使用容易混淆的/类似的类名、字段名
* 避免命名字段过长

####代码注释

* 在合理的情况下，越详细越好
* 接口/类/方法上使用文档注释，如下：
```java
	/**
	* 解释本类/接口/方法干什么
	* <方法标明参数、返回值等信息>
	* 标明Coder及编码时间
	*/
```
* 字段使用单行注释：`//`

####代码结构	

* 编码过程中注意原项目架构的分层结构，增加类对象放置在合理包下
* 遵循对象的`单一职责`原则，一个类的功能尽量不要太杂乱
* 有`原子性`特性的功能尽量对外提供一个简洁易于理解的方法/接口，方便其它地方调用同时也有利于事务控制
* 保持代码良好格式，且避免无用import导致额外开销
```java
Ctrl + Shift + F 格式化源代码
Ctrl + Shift + O 管理import语句并移除未使用的语句
```
* `if/else`及`for`等结构使用`{}`,提升代码可读性
* 提取重要且常用变量到属性文件中配置或常量类中定义，项目中有`Constants`常量类专门存放
* 切勿轻易修改项目核心配置文件

####简单代码效率优化

* 长字符串使用`StringBuffer/StringBuilder`，使用`StringBuffer/Builder.clear()`重置后重复使用，避免多次创建新对象，可以有效的节省JVM堆内存。
* Map结构关注使用时的元素个数，在创建时根据实际情况指定初始化大小以及负载因子，默认大小16/负载因子为0.75f。需要注意的是`容量`需指定为`2的次方`，且避免过小引起Map自动扩容，当元素个数>=容量*负载因子时会自动扩容
* 尽量避免在循环中new对象
* 避免出现死循环
* 避免在方法中多次使用同样的字符串，在当前类定义一个常量或者在`Constants`常量类中创建，其它地方使用即可

##SVN版本控制
> ***要求***：切勿随意提交 更新/提交前同步

####保证代码完整
* 在确定功能完整无编译无错的情况再提交代码
* 不要擅自删除文件/代码
####避免冲突
* 修改某个文件时，尽量先更新且锁定代码，避免出现多人同时修改冲突的情况，后期代码量越多越难解决，非常浪费时间
* 更新时，使用`与资源库同步`功能，比对是否冲突后再更新，尽量不要直接在工程上直接`右键>Team>更新`

##数据库设计规范
>  ***要求***：无外键设计 系统当前数据库为SqlServer 遵从数据库建模规范 数据库表与PowerDesigner模型同步

####PowerDesigner模型设计
* 表定义
	- Name使用中文注释
	- Code为`T_ESS_`开头
	- 举例：用户表->`T_ESS_USER`

* 字段定义
	- Name使用中文注释
	- Code为`F`开头
	- 举例：主键-><abbr title="主键命名">`FID`</abbr>

* 类型定义
	- 主键->`bigint`,中文字段->`nvarchar(16)`
	- 日期时间->`datetime`
	- 非中文字符串->`varchar(32)`
	- 单字符->`char(1)`
	- 金额数字->`decimal(23,10)`
	- 语言标识(2052代表中文)->`int`
* 主键/索引/默认值定义
	- 主键使用`identity`自增长
	- 尽量使用联合索引，节省开销
	- 为字段分配默认值(`datetime`类型不分配默认值)
		- `bigint`->0
		- `varchar/nvarchar`->`''`
		- `decimal`->0
		- `char`->0
		- <abbr title='语言标识'>`FLOCALEID`</abbr>->2052

####迁移到数据库
* 在PowerDesigner中使用`Preview`功能，预览当前表的建表`SQL`
* 切勿完全复制，如果有模型中有外键约束，过滤掉
* 一般仅需要下面所示结构
```sql
/*==============================================================*/
/* Table: T_ESS_LOGISTICS_STATUS                                */
/*==============================================================*/
create table T_ESS_LOGISTICS_STATUS (
   FID                  bigint               identity,
   FORDERID             bigint               not null default 0,
   FTIME                datetime             not null,
   FISDISPLAY           char(1)              not null default '1',
   constraint PK_T_ESS_LOGISTICS_STATUS primary key (FID)
)
go

/*==============================================================*/
/* Index: IDX_ESS_RECEIVERADDR_USERID                           */
/*==============================================================*/
create unique index IDX_ESS_RECEIVERADDR_USERID on T_ESS_LOGISTICS_STATUS (
FORDERID ASC
)
go
```
* 若有注释，需要一并带上


[^domain]:指域名
[^welcome-list]:项目<kbd>welcome-list</kbd>配置为view.jhtml
[^view]:在package kingdee.k3.o2o.base.webapp.action下的ViewDispatcherAction类
[^footnote]: 这里是 **脚注** 的 *内容*.
